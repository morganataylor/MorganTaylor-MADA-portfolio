---
title: "Visualization Exercise (Module 5)"
output: 
  html_document:
    theme: journal
    toc: FALSE
---

<br>

---

<br>

# The Rise of Terrorism Inspired By Religion in France

<br>

---

<br>

This exercise focuses on recreating the first figure reflected in FiveThirtyEight's article entitled, "The Rise of Terrorism Inspired By Religion In France." It previous deaths due to terrorism in France as well as the European Union from 1972 - 2014. The following code is an additive process as each element of the figure is replicated.

<br>

[Source article can be found here](https://fivethirtyeight.com/features/the-rise-of-religiously-inspired-terrorism-in-france/)

[GitHub repository with data](https://github.com/fivethirtyeight/data/tree/master/terrorism)

[Tidyverse ggplot2 help guide](https://ggplot2.tidyverse.org/)

---

## Libraries
Here are the libraries required to create this figure.

```{r}
library(here) #to define paths

library(dplyr) #to create total fatalities column

library(ggplot2) #to create area chart
```

<br>

## Import data
The first step was to download the data from the GitHub repository and import it.

```{r}
#define path to EU data
data_location_1 <- here::here("data","eu_terrorism_fatalities_by_country.csv")

#load EU data
EU_rawdata <- utils::read.csv(data_location_1, stringsAsFactors = FALSE)
```

<br>

## Clean EU data
I first added a total fatalities column to the data, and then I converted it to the long format. It took a couple tries before I realized that I needed to convert the country columns to numeric, as they were imported as numeric. I then filtered the data to select only the France and total fatalities.

```{r}
#create total column
EU_processeddata <- EU_rawdata %>% mutate(Total = rowSums(.[2:13]))

#look at structure of df
str(EU_processeddata)

#need to convert all numeric columns to numeric (not integers)
EU_processeddata[, 2:13] <- lapply(EU_processeddata[,2:13], as.numeric)

#recheck structure of df
str(EU_processeddata)

#convert to long format
data.table::setDT(EU_processeddata)
EU_processeddata_long <- data.table::melt(data = EU_processeddata,
                                  id.vars = "iyear",
                                  variable.name = "country",
                                  value.name = "fatalities")

#select only France and Total country values
chart_data <- dplyr::filter(EU_processeddata_long, country %in% c("France", "Total"))
```

<br>

## Default Area Chart
The first step was to create the default area chart generated by the ggplot2 package.

```{r}
#with defaults only
ggplot(chart_data, aes(x = iyear, y = fatalities, fill = country))+
  geom_area()
```

<br>

## Initial Customizations
I started with adjusting the immediately obvious changes: reordering the categories, hiding the legend, adding a title, changing the background of the plot area, and changing the colors.

```{r}
#reorder so France shows up on the bottom of stack
ggplot(chart_data, aes(x = iyear, y = fatalities, fill = factor(country, levels = c("Total", "France"))))+
  geom_area()

#add title and hide legend
ggplot(chart_data, aes(x = iyear, y = fatalities, fill = factor(country, levels = c("Total", "France")))) +
  geom_area(show.legend = FALSE) + 
  labs( x = "", y = "",
      title ="Previous Terrorism Deaths in France And The EU",
      subtitle = "Europen Union member countries as of 1986") +
  theme(
    plot.title = element_text(hjust = -0.15, vjust = 0, face = "bold"),
    plot.subtitle = element_text(hjust = -0.1, vjust = 0))

#adjusting background of plot to match
ggplot(chart_data, aes(x = iyear, y = fatalities, fill = factor(country, levels = c("Total", "France")))) +
  geom_area(show.legend = FALSE) + 
  labs( x = "", y = "",
      title ="Previous Terrorism Deaths in France And The EU",
      subtitle = "Europen Union member countries as of 1986") +
  theme(
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      panel.grid.major = element_line(colour = "#cccccc"),
      plot.background = element_rect(fill = "#EBEBEB"),
      plot.title = element_text(hjust = -0.15, vjust = 0, face = "bold"),
      plot.subtitle = element_text(hjust = -0.1, vjust = 0))

#change colors
ggplot(chart_data, aes(x = iyear, y = fatalities, fill = factor(country, levels = c("Total", "France")))) +
  geom_area(show.legend = FALSE) + 
  scale_fill_manual(values = c("#ffa999","#ff2700")) +
  labs( x = "", y = "",
      title ="Previous Terrorism Deaths in France And The EU",
      subtitle = "Europen Union member countries as of 1986") +
  theme(
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      panel.grid.major = element_line(colour = "#cccccc"),
      plot.background = element_rect(fill = "#EBEBEB"),
      plot.title = element_text(hjust = -0.15, vjust=0, face = "bold"),
      plot.subtitle = element_text(hjust = -0.1, vjust = 0))
```

<br>

## Add Labels
This step adds the text overlay labels. The arrow was tricky to get right, and I never did figure out how they completed a filled head arrow instead of an open one. The masterminds at Stack Overflow were incredibly helpful as I looked through old answers to understand how to adjust the arrow.

```{r}
#add France and EU labels
ggplot(chart_data, aes(x = iyear, y = fatalities, fill = factor(country, levels = c("Total", "France")))) +
  geom_area(show.legend = FALSE) + 
  scale_fill_manual(values = c("#ffa999","#ff2700")) +
  annotate("text", x = 1980, y = 50, 
           label = "France", 
           color = "#ff2700", 
           size = 4.5, 
           fontface = 2) +
  annotate("text", x = 1989, y = 350, 
           label = "European \nUnion", 
           color = "#ffa999", 
           size = 4.5, 
           fontface = 2, 
           hjust = 0) +
  labs( x = "", y = "",
      title ="Previous Terrorism Deaths in France And The EU",
      subtitle = "Europen Union member countries as of 1986") +
  theme(
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      panel.grid.major = element_line(colour = "#cccccc"),
      plot.background = element_rect(fill = "#EBEBEB"),
      plot.title = element_text(hjust = -0.15, vjust=0, face = "bold"),
      plot.subtitle = element_text(hjust = -0.1, vjust = 0)) 

#add Madrid train bombings label
ggplot(chart_data, aes(x = iyear, y = fatalities, fill = factor(country, levels = c("Total", "France")))) +
  geom_area(show.legend = FALSE) + 
  scale_fill_manual(values = c("#ffa999","#ff2700")) +
  annotate("text", x = 1980, y = 50, 
           label = "France", 
           color = "#ff2700", 
           size = 4.5, 
           fontface = 2) +
  annotate("text", x = 1989, y = 350, 
           label = "European \nUnion", 
           color = "#ffa999", 
           size = 4.5, 
           fontface = 2, 
           hjust = 0) +
  annotate("text", x = 2004, y = 255, 
           label = "2004 Madrid \ntrain bombings",
           color = "black",
           size = 4,
           hjust = 0.5) +
  geom_segment(aes(x = 2004, xend = 2004, y = 220, yend = 200),
               color = "black",
               arrow = arrow(length = unit(0.2, "cm"))) +
  labs( x = "", y = "",
      title ="Previous Terrorism Deaths in France And The EU",
      subtitle = "Europen Union member countries as of 1986") +
  theme(
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      panel.grid.major = element_line(colour = "#cccccc"),
      plot.background = element_rect(fill = "#EBEBEB"),
      plot.title = element_text(hjust = -0.15, vjust=0, face = "bold"),
      plot.subtitle = element_text(hjust = -0.1, vjust = 0)) 
```

<br>

## Fixing the Axes and Final Adjustments
This proved to be the trickiest step. I considered using the scales library to automatically overlay the x-axis labels. However, date formatting will always be my Achilles' heel in coding. I never managed to figure out how to convert the year variable to a date format that the scales library accepted. Instead, I just added new labels, adjusted the origin location, and figeted with the plot themes to make the final adjustments.

```{r}
#fix axes 
ggplot(chart_data, aes(x = iyear, y = fatalities, fill = factor(country, levels = c("Total", "France")))) +
  geom_area(show.legend = FALSE) + 
  scale_fill_manual(values = c("#ffa999","#ff2700")) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  scale_x_continuous(breaks = seq(1970, 2014, by = 5), 
        labels = c("1970", "'75", "'80", "'85", "'90", "'95", "2000", "'05", "'10")) +
  annotate("text", x = 1980, y = 50, 
           label = "France", 
           color = "#ff2700", 
           size = 4.5, 
           fontface = 2) +
  annotate("text", x = 1989, y = 350, 
           label = "European \nUnion", 
           color = "#ffa999", 
           size = 4.5, 
           fontface = 2, 
           hjust = 0) +
  annotate("text", x = 2004, y = 255, 
           label = "2004 Madrid \ntrain bombings",
           color = "black",
           size = 4,
           hjust = 0.5) +
  geom_segment(aes(x = 2004, xend = 2004, y = 220, yend = 200),
               color = "black",
               arrow = arrow(length = unit(0.2, "cm"))) +
  labs( x = "", y = "",
      title ="Previous Terrorism Deaths in France And The EU",
      subtitle = "Europen Union member countries as of 1986") +
  theme(
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      panel.grid.major = element_line(colour = "#cccccc"),
      plot.background = element_rect(fill = "#EBEBEB"),
      axis.line.x = element_line(color="#5b5e5f", size = 0.5),
      axis.ticks.length = unit(0.25, "cm"),
      axis.ticks = element_line(colour = "#cccccc"),
      axis.text=element_text(size=12),
      plot.title = element_text(hjust = -0.35, vjust=0, face = "bold", size = 16),
      plot.subtitle = element_text(hjust = -0.15, vjust = 0, size = 14))
```

<br>

---

<br>

## Final Product
This is the final figure generated by the code to replicate FiveThirtyEight's article.

```{r}
ggplot(chart_data, aes(x = iyear, y = fatalities, fill = factor(country, levels = c("Total", "France")))) +
  geom_area(show.legend = FALSE) + 
  scale_fill_manual(values = c("#ffa999","#ff2700")) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  scale_x_continuous(breaks = seq(1970, 2014, by = 5), 
        labels = c("1970", "'75", "'80", "'85", "'90", "'95", "2000", "'05", "'10")) +
  annotate("text", x = 1980, y = 50, 
           label = "France", 
           color = "#ff2700", 
           size = 4.5, 
           fontface = 2) +
  annotate("text", x = 1989, y = 350, 
           label = "European \nUnion", 
           color = "#ffa999", 
           size = 4.5, 
           fontface = 2, 
           hjust = 0) +
  annotate("text", x = 2004, y = 255, 
           label = "2004 Madrid \ntrain bombings",
           color = "black",
           size = 4,
           hjust = 0.5) +
  geom_segment(aes(x = 2004, xend = 2004, y = 220, yend = 200),
               color = "black",
               arrow = arrow(length = unit(0.2, "cm"))) +
  labs( x = "", y = "",
      title ="Previous Terrorism Deaths in France And The EU",
      subtitle = "Europen Union member countries as of 1986") +
  theme(
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      panel.grid.major = element_line(colour = "#cccccc"),
      plot.background = element_rect(fill = "#EBEBEB"),
      axis.line.x = element_line(color="#5b5e5f", size = 0.5),
      axis.ticks.length = unit(0.25, "cm"),
      axis.ticks = element_line(colour = "#cccccc"),
      axis.text=element_text(size=12),
      plot.title = element_text(hjust = -0.35, vjust=0, face = "bold", size = 16),
      plot.subtitle = element_text(hjust = -0.15, vjust = 0, size = 14))
```